# 🦖 인프런 운영체제 공룡책 강의

## Section 7

### 데드락

- 데드락의 4가지 필수 조건
    - 상호 배제: 최소 하나의 자원이 공유될 수 없는 상태를 유지하고 있는 상태
    - 점유 대기: lock을 획득한 스레드가 존재하면서 동시에 접근한 또다른 스레드도 동일한 lock을 획득하게 되어 서로 무한정 대기
    - 선점 불가: 선점이 가능하다면 강제로 빼앗을 수 있으므로 데드락이 발생할 수 없다.
    - 원형 대기: 서로의 작업이 끝나고 작업을 하려고 순환하는 형태로 기다리는 상태

- Resource-Allocation Graph
    - 자원 할당 그래프
    - 데드락을 이해하기 위한 그래프

- 데드락 문제를 처리하기 위한 방법
    - 무시
        - 시스템에 절대 데드락이 발생하지 않을 것이라고 가정하고 데드락 문제 자체를 고려하지 방법
    - 방지
        - 모든 상황의 데드락을 방지 -> 데드락을 완전히 방지하기는 어렵다.
        - 4가지 데드락 필수 조건 중 하나를 방지하기
            - 상호 배제를 제거해보자: 모든 리소스를 공유 가능하게 만들기
                - 불가능 -> 본질적으로 mutex lock은 공유 불가, mutex lock을 사용하기만 해도 공유 불가능한 자원이다.
                - 상호 배제 가능한 조건은 애초에 데드락이 발생하지 않으므로 고려할 필요조차 없다.
            - 점유 대기를 제거해보자: 새로운 작업을 추가로 하기위해서는 기존의 점유를 모두 해제하고 작업에 필요한 점유들을 다시 점유하게 만들기
                - 실용적으로 사용하기 어려운 방법
            - 선점 불가를 제거해보자: 선점을 빼앗을 수 있도록 동작하게 만들기
                - 모든 리소스들이 preemption 하다면 실용적으로 사용하기 어렵다
            - 순환 대기를 제거해보자: 모든 리소스 타입에 순서를 부여
                - 자원을 부여할 때, 순서가 큰 번호에게만 점유를 내주기 -> 만약 큰 것이 없다면 점유를 그냥 내려놓기
                - 하지만, 기아현상이 발생할 가능성이 존재한다.
        - 방지 기법을 통해 데드락을 해결하려고 한다면 이용률 또는 처리량이 줄어들 수 밖에 없게된다.
    - 회피
        - 데드락 가능성을 회피하기 위해 스레드를 wait 시키는 방법
            - 회피하기 위한 미래의 동작을 알고 있어야 한다.
        - Safe State: 작업을 처리하기 위한 스레드들에게 최대 멕시멈의 자원까지 할당할 수 있는 상태 (데드락이 발생할 수 없는 상태)
            - threads의 순서는 safe sequence로 존재해야만 한다. (데드락이 발생하지 않는 순서)
        - 은행원 알고리즘
            - N개의 스레드 환경에서 m개의 리소스 타입이 존재할 때
                - Available: 이용가능한 자원 타입의 수
                - Max: 각 스레드에 앞으로 요청할 리소스 인스턴스의 최대 수
                - Allocation: 스레드에 현재 할당된 리소스의 수
                - Need: 앞으로 요청할 리소스를 의미 (현재 스레드의 (Max - Allocation))
    - 데드락 발생 후, 회복
        - 데드락 문제가 발견하게 되면, 데드락을 회복 시키는 방법
        - 데드락 회복방법
            - 프로세스와 스레드 종료시키기
                - 데드락에 걸린 모든 프로세스를 종료 후 실행
                - 또는 사이클이 발생해서 데드락이 발생했을 경우도 있으니 하나씩 죽여보면서 데드락 해결
            - 자원 선점
                - 가장 작은 비용이 드는 작업을 선점하는 방식으로 희생자를 선정 후 task를 롤백 후 재실행
                    - 가장 작은 비용이 드는 작업에 동일한 작업만 희생자로 선정될 경우 기아현상이 발생될수도 있기에 희생자 선정 횟수를 제한하기
          